---
title: "alexadia"
author: "Alexander Adia"
date: "November 28, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r}
#zip codes for state
data(zipcode)

#takes a value for state and returns all the zipcodes from the state
zips_from_state<-function(state_name){
  zip_holder<-zipcode%>%
    filter(state==state_name)%>%
    select(zip)
  zip_state<-zip_holder[,1]
  return(zip_state)
}
zip.ri<-zips_from_state("RI")
zip.ca<-zips_from_state("CA")
zip.nd<-zips_from_state("ND")

```

```{r}
#takes a city name and returns all the zipcodes from the city
zips_from_city<-function(city_name){
    zip_holder<-zipcode%>%
    filter(city==city_name)%>%
    select(zip)
  zip_city<-zip_holder[,1]
  return(zip_city)
}

zip.pvd<-zips_from_city("Providence")
zips.wantagh<-zips_from_city("Wantagh")

```

```{r}
   providertype <- c("Psychologist Addiction (Substance Use Disorder)", "Counselor Mental Health",  "Psychiatry & Neurology Psychiatry", "Social Worker Clinical", "Counselor Mental Health", "Counselor", "Psychologist Clinical", "Psychologist", "Marriage & Family", "Therapist", "Social Worker", "Clinic/Center Adult Mental Health") 

NPIcode<-function(zipcode, providertype){
  url1<- "https://npiregistry.cms.hhs.gov/registry/search-results-table?addressType=ANY&postal_code=" #setting the url to scrape from
  provider.data <- data.frame() #initializing an empty data frame
  skips <- seq(0,9999999999,100) #create skips
  for (i in 1:length(zipcode)) { #iterating over all RI zip codes
    for (j in 1:length(skips)){ #also iterating over skils
      zip <- zipcode[i]
      skip <- skips[j]
  url<-paste0(url1,zip,"&skip=",skip) #pasting the url, with the rhode island zip code and including the skips
  #text scrape to pull our places by zip code
  h <- read_html(url, timeout = 200)
  reps <- h %>% #setting up the repeating structure
     html_node("table") %>%
     html_table()
    if (any(is.na(reps[,1])) | all(is.na(reps[,1]))) { #if the page has no physicians, move to next zip code
    break}
  reps$zip <- zipcode[i]
  provider.data <- rbind(provider.data,reps) #binding together the provider data and reps data
    }
  }
   colnames(provider.data) <- c("NPI","Name","NPI_Type","Primary_Practice_Address","Phone","Primary_Taxonomy","zipcode")

filteredtable <- provider.data%>%
    filter(Primary_Taxonomy %in% providertype) 

  return(filteredtable)
}

provider.data <- NPIcode(zip.ri, "Dermatology")
provider.data

```

```{r}
providr_describr<-function(stat, data){
  
}

```

```{r}
primary_care_data<-NPIcode(zip.ri, "primary care")

```

```{r}
group_by_unit<-function(data, unit){
  if(unit=="zipcode"){
    countbyzip<-data%>%
    group_by(zipcode) %>% 
    count() %>%
    arrange(n) 
    
    return(countbyzip)
  } else if (unit==="county") {
    countbycounty<-data%>%
    group_by(county) %>% 
    count() %>%
    arrange(n) 
    
    return(countbycounty)
  } else if (unit=="state"){
    countbystate<-data%>%
    group_by(state) %>% 
    count() %>%
    arrange(n) 
    
    return(countbystate)
  } else if (unit=="city"){
    countbycity<-data%>%
    group_by(city) %>% 
    count() %>%
    arrange(n) 
    
    return(countbycity)
  } else if (unit=="type"){
    countbyprovider<-data%>%
    group_by(Primary_Taxonomy) %>% 
    count() %>%
    arrange(desc(n)) 
    
    return(countbyprovider)
  }
}
```
```{r}
countbyzip <- provider.data %>% #creating a count of practices by zip code
group_by(zipcode) %>% 
count() %>%
arrange(n) 

#countbyzip
#create a bar graph of providers by frequency
plot<-ggplot(countbyzip, aes(x=zipcode, y=n, fill="#FF6666"))+
  geom_bar(stat="identity")
plot

#number of counties with 1 provider, 2 providers, etc

number_practices<-countbyzip %>%
  select(n) %>% #selecting and grouping by frequency
  group_by(n) %>%
  count() %>%
  arrange(n) #arranging by frequency
number_practices.low <- head(number_practices) #getting the first rows of the number_pratices and desingnating them as low numbers of practices

#add axis names
plot<-ggplot(number_practices.low, aes(x=factor(n), y=nn))+
  geom_bar(stat="identity") + labs(x = "Number of providers", y = "Number of zip codes")
plot
```

```{r}
#Graphs of Provider Type
provider_grouping<-provider.data %>% #creating a count of practices by providers
group_by(Primary_Taxonomy) %>% 
count() %>%
arrange(desc(n)) 
#provider_grouping

#general scatter of all providers types
provider_scatter<-ggplot(provider_grouping, aes(x=Primary_Taxonomy, y=n))+
 geom_point()+
    theme(axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  labs(x = "Provider Types", y = "Number of providers")+
  scale_color_brewer(palette="Set1")
provider_scatter

#create a bar graph of top 5 providers by frequency
top5providers<-head(provider_grouping)
providers_bar<-ggplot(top5providers, aes(x=Primary_Taxonomy, y=n))+
  geom_bar(stat="identity")+
  theme(axis.text.x = element_text(angle=90))+
  labs(x = "Provider Type", y = "Number of Providers")
providers_bar

```

```{r}
#problem: no way to get county from these codes, maybe from this data? https://www.unitedstateszipcodes.org/zip-code-database/
county_collect_NPIcode_taxonomy<-function(county,taxonomy){
  url1<- "https://npiregistry.cms.hhs.gov/registry/search-results-table?addressType=ANY&postal_code=" #setting the url to scrape from
  provider.data <- data.frame() #initializing an empty data frame
  skips <- seq(0,9999999,100) #create skips
  for (i in 1:length(county)) { #iterating over all counties
    for (j in 1:length(skips)){ #also iterating over skils
      county_index <- county[i]
      skip <- skips[j]
      tax <- str_replace_all(taxonomy," ","+")
  url<-paste0(url1,count_index,"&skip=",skip,"&taxonomy_description=",tax) #pasting the url, with the county and including the skips
  #text scrape to pull our places by county
  h <- read_html(url, timeout = 200)
  reps <- h %>% #setting up the repeating structure
     html_node("table") %>%
     html_table()
    if (any(is.na(reps[,1])) | all(is.na(reps[,1]))) { #if the page has no physicians, move to next county
    break}
  reps$county <- county[i]
  provider.data <- rbind(provider.data,reps) #binding together the provider data and reps data
    }
  }
   colnames(provider.data) <- c("NPI","Name","NPI_Type","Primary_Practice_Address","Phone","Primary_Taxonomy","zipcode")
  return(provider.data)
}
provider.data<-NPIcode_taxonomy("02906", "Mental Healt")
provider.data

```