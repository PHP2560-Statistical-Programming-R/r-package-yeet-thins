---
title: "functionmaking"
author: "Jackie Goldman"
date: "November 28, 2018"
output: html_document
---

```{r setup, include=FALSE}
options(scipen = 3, digits = 3)
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
knitr::opts_chunk$set(cache=T)
knitr::opts_chunk$set(collapse=T)
```

```{r}
library(rvest)
library(httr)
library(dplyr)
library(jsonlite)
library(XML)
library(stringr)
library(zipcode)
library(dplyr)
library(stringr)
library(ggplot2)
```
```{r}
#getting zipcode package
library(zipcode)
data(zipcode)
zip.ri <- filter(zipcode,state=="RI")$zip #restricting to RI zip codes
zip.ri <- as.vector(zip.ri)
zip.ri<-zip.ri
```


```{r}
#looping over zip codes and pages when there are more than 100 providers per zip code
provider.data <- provider.data %>%
  mutate(zipcode = as.character(zipcode))

```


```{r}
zcta_county_rel_10 <- read_csv("~/RA work continuous/Manuscript submissions/SAJ_suspected involvment of fentanyl/Resubmission/zcta_county_rel_10.txt")
zcta_county_rel_10
zip_link<-zcta_county_rel_10 %>%
  select(ZCTA5, STATE, COUNTY, GEOID) %>%
  rename(zipcode = ZCTA5)

#cleaning the provider data
provider.data$street <- noquote( str_extract(provider.data$Primary_Practice_Address,pattern="^[a-zA-Z0-9_. -]+?(?=\n)")) #street name and number

provider.data$city <- noquote( str_extract(provider.data$Primary_Practice_Address,pattern="(?<=\t)[a-zA-Z_. -]+?(?=, )"))#city

provider.data$state <- noquote( str_extract(provider.data$Primary_Practice_Address,pattern="(?<=, )[A-Z]+(?=\\s)")) #state postal code (2 characters)

#joining the census link with the NPI data

NPI_join<-full_join(provider.data, zip_link, by="zipcode")
head(NPI_join)

#uploading census data
census <- read.csv("~/Masters Semester 3/Programming/co-est2017-alldata.csv")
#make data type compatible
census<-census %>%
  mutate(COUNTY = as.character(COUNTY))

#join link with census data

NPI_to_census<-right_join(NPI_join, census, by=c("STATE", "COUNTY"))
head(NPI_to_census)
```

```{r}
#getting census data into R

head(census$COUNTY)

library(censusr)

#this function gives us census tract block
geoid <- call_geolocator(provider.data$street[1],provider.data$city[1],provider.data$state[1])

#county-level data
call_census_api(variables_to_get="B06011_001E",geoids=geoid,allgeos='co',data_source="acs",api_key = Sys.getenv("CENSUS_TOKEN"))

census <- read.csv("co-est2017-alldata.csv")
#use POPESTIMATE2017 and CTYNAME for 2017 population estimates
#if we want 2010 population use POPESTIMATE2010
```
